# 「組織目標グラフ」表示ロジック仕様書

## 1. 概要

このドキュメントは、従業員向けアプリのダッシュボードに表示される**組織単位の目標グラフ**について、そのデータ処理と描画ロジックを技術的に詳述します。

このグラフは、ユーザー操作（「時間軸」と「実績を積上」スイッチ）に応じて、表示内容が動的に変化します。

---

## 2. データソース

グラフ描画には、Firestoreの2つのコレクションが使用されます。

1.  **`goals` コレクション**:
    *   **パス**: `/goals/{goalId}`
    *   **目的**: グラフの基本設定（タイトル、期間、全体の目標値、デフォルト表示など）を保持します。
    *   **主な使用フィールド**:
        *   `scope`: `'team'` であることを確認
        *   `chartType`: `'donut'`, `'bar'`, `'line'`, `'composed'`
        *   `startDate`, `endDate`: グラフの期間範囲
        *   `targetValue`: 期間全体の目標値
        *   `unit`: 値の単位 (`件`, `%` など)
        *   `defaultGranularity`, `defaultIsCumulative`: グラフの初期表示設定

2.  **`goalRecords` サブコレクション**:
    *   **パス**: `/goals/{goalId}/goalRecords/{recordId}`
    *   **目的**: 時系列グラフ（棒、折れ線など）の日付ごとの実績データを格納します。
    *   **主な使用フィールド**:
        *   `date`: 実績が記録された日付 (Timestamp)
        *   `actualValue`: その日の実績値 (Number)

---

## 3. UIコントロールと状態

ユーザーは2つのUIコントロールを通じて、グラフの表示をインタラクティブに変更できます。

1.  **時間軸 (Granularity) セレクター**:
    *   **選択肢**: `日ごと (daily)`, `週ごと (weekly)`, `月ごと (monthly)`
    *   **役割**: X軸の単位を切り替えます。データは選択された粒度で集計されます。

2.  **「実績を積上」 (Cumulative) スイッチ**:
    *   **状態**: `ON` / `OFF`
    *   **役割**: グラフのデータ集計方法と描画目的を根本的に切り替えます。
        *   `OFF`: 各期間（日/週/月）の**単独のパフォーマンス**を評価します。
        *   `ON`: 開始日から現在までの**累計の進捗**を追跡します。

---

## 4. 表示ロジック詳細

`src/components/dashboard/widget-preview.tsx` 内で、主に `isCumulative` の状態によって処理が分岐します。

### 4.1. 「実績を積上」スイッチがOFFの場合

*   **目的**: 各期間（日/週/月）ごとの独立したパフォーマンスを可視化する。
*   **データ集計ロジック**:
    1.  まず、`goalRecords` の全データを、選択された「時間軸」 (`daily`, `weekly`, `monthly`) に基づいてグループ化します。
    2.  各グループ内の `actualValue` を**合計**し、その期間の `periodActual` (期間実績) を算出します。
    3.  `periodTarget` (期間目標) は、`期間全体の目標値 (targetValue)` を `表示されている棒の本数` で均等に割ることで算出します。
*   **グラフ描画ルール (`TeamGoalPeriodicBarChart`)**:
    *   **グラフタイプ**: 棒グラフとして描画されます。
    *   **棒の描画**:
        *   各棒は、まず `periodActual` の値まで描画されます。
        *   実績 (`periodActual`) が期間目標 (`periodTarget`) を超えた場合、その超過分が**青色**で積み重ねて描画され、達成度が視覚的に強調されます。
        *   実績が目標に満たない場合は、実績値までが**緑色**で描画されます。
    *   **参照線**:
        *   `periodTarget` (期間ごとの目標値) が、点線としてグラフ上に描画され、各期間での達成目標を明確にします。
*   **ツールチップ表示例**:
    *   `週ごと`表示で`8/1-8/7`の棒にカーソルを合わせると → `「8月1日〜8月7日の実績: 80件」`

### 4.2. 「実績を積上」スイッチがONの場合

*   **目的**: 目標期間の開始から現在までの累計進捗と、最終ゴールに対する達成率を可視化する。
*   **データ集計ロジック**:
    1.  まず、`4.1` と同様に時間軸でグループ化し、`periodActual` (期間実績) を算出します。
    2.  次に、各期間の `periodActual` を時系列で**順に足し上げて**いき、各時点での `cumulativeActual` (累計実績) を算出します。
    3.  `cumulativeAchievementRate` (累計達成率) は、以下の式で計算されます。
        *   `(cumulativeActual / targetValue) * 100`
*   **グラフ描画ルール (`TeamGoalCumulativeChart`)**:
    *   **グラフタイプ**: `goals` ドキュメントの `chartType` (`composed`, `bar`, `line`) に基づいて描画されます。
    *   **`composed` (複合グラフ)**:
        *   **棒グラフ**: `cumulativeActual` (累計実績) を右肩上がりの階段状に描画します。
        *   **折れ線グラフ**: `cumulativeAchievementRate` (累計達成率) を、右側のY軸に対応させて描画します。
    *   **`bar` (棒グラフ)**: `cumulativeActual` (累計実績) のみを描画します。
    *   **`line` (折れ線グラフ)**: `cumulativeActual` (累計実績) のみを描画します。
    *   **参照線**:
        *   `targetValue` (期間全体の目標値) が、点線としてグラフ上に描画され、最終的なゴールラインを示します。
*   **ツールチップ表示例**:
    *   `週ごと`表示で`8/1-8/7`の時点にカーソルを合わせると → `「累計実績: 80件」「累計達成率: 8%」`

---

この仕様書が、組織目標グラフの複雑なロジックを理解する一助となれば幸いです。