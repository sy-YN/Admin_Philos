# カレンダー機能 データベース設計・仕様書

## 1. 概要

このドキュメントは、管理者画面で設定された「日替わりメッセージ」と「期間指定メッセージ」を、従業員向けアプリのカレンダーにどのように表示するかの技術仕様とデータベース設計を定義します。

本機能の核心は、**「期間指定メッセージ」を「日替わりメッセージ」よりも優先して表示する**ロジックにあります。

---

## 2. データベース設計 (Firestore)

この機能は、役割の異なる以下の3つのコレクション/ドキュメントを利用して実現されます。

```mermaid
graph TD
    subgraph "従業員向けアプリ (表示ロジック)"
        A{今日の日付は...};
        B{期間指定メッセージの<br>期間内か？};
        C[期間指定メッセージを表示];
        D[日替わりメッセージを表示];
        E[カウンターを見て<br>次のメッセージを決定];
        
        A --> B;
        B -- Yes --> C;
        B -- No --> E;
        E --> D;
    end

    subgraph "Firestoreデータベース"
        F1(fixedCalendarMessages<br>コレクション);
        F2(calendarMessages<br>コレクション);
        F3(settings/calendarDisplay<br>ドキュメント);

        F1 -.-> B;
        F2 -.-> E;
        F3 -.-> E;
    end

    style C fill:#ffe4e1,stroke:#b22222
```

### 2.1. `calendarMessages` コレクション (日替わり用)

通常時に毎日順番に表示されるメッセージ群を格納します。

-   **コレクションパス**: `calendarMessages`
-   **ドキュメントの主なフィールド**:
    -   `title` (string): メッセージのタイトル
    -   `content` (string): メッセージの本文（HTML形式）
    -   `icon` (string): アイコン名
    -   `order` (number): 表示順を決定する数値（昇順）

### 2.2. `fixedCalendarMessages` コレクション (期間指定用)

特定の期間に優先して表示したい、単発または短期のメッセージを格納します。

-   **コレクションパス**: `fixedCalendarMessages`
-   **ドキュメントの主なフィールド**:
    -   `title` (string): メッセージのタイトル
    -   `content` (string): メッセージの本文（HTML形式）
    -   `icon` (string): アイコン名
    -   `startDate` (Timestamp): このメッセージの**表示開始日**
    -   `endDate` (Timestamp): このメッセージの**表示終了日**

### 2.3. `settings/calendarDisplay` ドキュメント

日替わりメッセージの表示サイクルを管理するためのカウンターを保持します。

-   **コレクションパス**: `settings`
-   **ドキュメントID**: `calendarDisplay`
-   **フィールド**:
    -   `dailyLoopCounter` (number): `calendarMessages`の`order`と対応し、次に表示すべきメッセージの番号を記録しています。

---

## 3. アプリケーション側の表示ロジック

従業員向けアプリがカレンダーページを開いた際、以下のステップで表示内容を決定します。

1.  **【最優先】期間指定メッセージの検索**:
    -   まず、`fixedCalendarMessages`コレクションを検索し、**今日の日付が`startDate`と`endDate`の範囲内に含まれる**ドキュメントがあるかを確認します。
    -   該当するドキュメントが**見つかった場合**、そのメッセージを表示し、以降の処理はすべて中断します。
    -   もし複数のメッセージが該当期間にある場合は、`startDate`が最も新しいものが優先されます。

2.  **【通常】日替わりメッセージの表示**:
    -   上記1.で該当するメッセージが**見つからなかった場合**にのみ、こちらのロジックが実行されます。
    -   `settings/calendarDisplay`ドキュメントから現在の`dailyLoopCounter`の値を取得します。
    -   `calendarMessages`コレクション全体を`order`順で取得し、`dailyLoopCounter`の値に対応する順序のメッセージを表示します。
    -   （例: `dailyLoopCounter`が`3`なら、`order`が`3`のメッセージを表示）
    -   **重要**: 期間指定メッセージが表示されている間、`dailyLoopCounter`は進みません。これにより、特別期間が終わった翌日には、中断された時点の続きから日替わり表示が再開されます。

3.  **表示コンテンツがない場合**:
    -   どのコレクションにも表示すべきメッセージが1件も登録されていない場合は、エラーとせず、カレンダーエリアには何も表示しません。

この設計により、管理者は日々のメッセージローテーションを自動で回しつつ、任意のタイミングで特別なメッセージに割り込ませることが可能になります。
