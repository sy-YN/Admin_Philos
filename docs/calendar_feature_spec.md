# 「行動指針カレンダー」機能実装仕様書

## 1. 概要

このドキュメントは、Philosの従業員向けアプリに表示される「行動指針カレンダー」のデータモデル、表示ロジック、および管理者向けの設定機能に関する仕様を定義します。

このカレンダーは、以下の2種類のメッセージを組み合わせて表示します。

1.  **期間指定メッセージ**: 特定の期間（例：今週、新製品ローンチ期間）に固定で表示されるメッセージ。
2.  **日替わりメッセージ**: 期間指定メッセージがない日に、ローテーションで表示されるメッセージ。

---

## 2. データベース設計

本機能は、Firestoreの3つのコレクション/ドキュメントを使用します。

### 2.1. `fixedCalendarMessages` (期間指定メッセージ)

*   **コレクションパス**: `/fixedCalendarMessages`
*   **ドキュメントID**: 自動生成
*   **目的**: 特定の期間に表示するメッセージを格納します。

```typescript
// データモデル (FixedCalendarMessage)
{
  title: string;        // メッセージのタイトル
  content: string;      // メッセージの内容 (HTML形式)
  icon: string;         // Lucideアイコン名
  startDate: Timestamp; // 表示開始日
  endDate: Timestamp;   // 表示終了日
  order: number;        // 表示優先度 (昇順。小さいほど優先度が高い)
  authorId: string;     // 作成者のUID
  authorName: string;   // 作成者の表示名
  createdAt: Timestamp; // 作成日時
  updatedAt: Timestamp; // 最終更新日時
}
```

### 2.2. `calendarMessages` (日替わりメッセージ)

*   **コレクションパス**: `/calendarMessages`
*   **ドキュメントID**: 自動生成
*   **目的**: 日替わりでローテーション表示するメッセージのプールを格納します。

```typescript
// データモデル (CalendarMessage)
{
  title: string;        // メッセージのタイトル
  content: string;      // メッセージの内容 (HTML形式)
  icon: string;         // Lucideアイコン名
  order: number;        // 表示順 (昇順)
  authorId: string;     // 作成者のUID
  authorName: string;   // 作成者の表示名
  createdAt: Timestamp; // 作成日時
  updatedAt: Timestamp; // 最終更新日時
}
```

### 2.3. `settings/calendarDisplay` (カレンダー表示設定)

*   **コレクションパス**: `/settings`
*   **ドキュメントID**: `calendarDisplay` (固定)
*   **目的**: 日替わりメッセージの表示状態をグローバルに管理します。

```typescript
// データモデル (CalendarDisplaySettings)
{
  dailyLoopCounter: number; // 現在の日替わりメッセージの 'order' を指すカウンター
  lastUpdatedDate: Timestamp; // カウンターが最後に更新された日付
}
```

---

## 3. 従業員向けアプリの表示ロジック

従業員がカレンダーページを開いた際の、表示メッセージ決定フロー。

```mermaid
graph TD
    A[ページ表示開始] --> B{今日の日付は<br>期間指定メッセージの<br>範囲内か？};
    B -- Yes --> C{重複する期間指定が<br>複数あるか？};
    B -- No --> D[日替わりメッセージの<br>ロジックへ];

    C -- No --> C1[該当の期間指定<br>メッセージを表示];
    C -- Yes --> C2[orderが最も小さい<br>(優先度が高い)ものを<br>1つだけ表示];
    
    C1 --> Z[作成者名と共に<br>メッセージを表示し、<br>処理終了];
    C2 --> Z;

    subgraph "日替わりメッセージの表示ロジック"
        direction TB
        D --> E{Firestoreから<br>settings/calendarDisplay<br>を読み込む};
        E --> F{lastUpdatedDateは<br>今日より前か？};
        F -- Yes (日付が変わった) --> G[今日の最初の<br>アクセス者];
        F -- No (今日の日付) --> H[今日のアクセス者<br>(2人目以降)];
        
        G --> I{dailyLoopCounterを+1し、<br>lastUpdatedDateを<br>今日の日付に更新};
        H --> J[カウンターは<br>更新しない];

        I --> K[更新後のカウンター値<br>を取得];
        J --> K;
        
        K --> L{全日替わりメッセージを<br>order順で取得};
        L --> M{カウンター値に対応する<br>メッセージを特定<br>(剰余演算を使用)};
    end
    
    M --> Z;

```

### 3.1. 期間指定メッセージの優先表示

1.  まず、今日の日付が、`fixedCalendarMessages`コレクションのいずれかのドキュメントの`startDate`から`endDate`の範囲に含まれるかを確認します。
2.  該当するメッセージが**1つ**だけあれば、そのメッセージを表示します。
3.  該当するメッセージが**複数**ある場合（期間が重複している場合）、`order`の値が最も小さい（＝優先度が最も高い）メッセージを**1つだけ**選択して表示します。

### 3.2. 日替わりメッセージの表示 (1日1回更新)

期間指定メッセージが表示されない日に、このロジックが実行されます。

1.  **設定読み込み**: `settings/calendarDisplay`ドキュメントを読み込みます。
2.  **日付比較**: ドキュメント内の`lastUpdatedDate`と**今日の日付**を比較します。
3.  **カウンター更新判定**:
    *   もし`lastUpdatedDate`が今日より前であれば、このアクセスが**今日の最初のアクセス**と判断します。
    *   **トランザクション**またはバッチ書き込みを用いて、`dailyLoopCounter`を1つインクリメントし、`lastUpdatedDate`を今日の日付に更新します。
    *   もし`lastUpdatedDate`が今日の日付であれば、既に誰かが更新済みのため、書き込みは行いません。
4.  **表示メッセージ決定**:
    *   `calendarMessages`コレクションを`order`順で全て取得します。
    *   現在の`dailyLoopCounter`の値を、全メッセージ数で割った**余り**を計算します。
    *   その余りの値に対応する`order`を持つメッセージを「今日表示するメッセージ」として決定します。
    *   例: メッセージが5件、カウンターが`7`の場合 → `7 % 5 = 2` → `order: 2`のメッセージが表示されます。

### 3.3. 作成者情報の表示
*   表示が決定したメッセージ（期間指定・日替わりの両方）について、`content`と共に`authorName`フィールドの値も画面に表示し、「誰が作成したメッセージか」をユーザーに伝えます。

---

## 4. 管理者向け画面の機能要件

*   **タブ切り替え**: 「日替わりメッセージ」と「期間指定メッセージ」を管理するUIをタブで明確に分離します。
*   **CRUD操作**: 両方のメッセージタイプに対して、新規作成、編集、削除ができるUIを提供します。
*   **ドラッグ＆ドロップによる順序変更**:
    *   「日替わりメッセージ」と「期間指定メッセージ」の両方のリストで、ドラッグ＆ドロップによる直感的な並べ替え機能を提供します。
    *   この並べ替え操作により、各メッセージの`order`フィールドが更新され、表示順や優先度が変更されます。
*   **作成者情報の自動記録**:
    *   管理者がメッセージを新規作成または編集して保存する際、現在ログインしている管理者の`uid`と`displayName`を、それぞれ`authorId`と`authorName`として自動的に記録します。
    *   メッセージ一覧には、誰がいつ作成・更新したかの情報も表示します。
```