# 「組織単位の目標設定」機能仕様書

## 1. 概要

このドキュメントは、管理者向け画面および従業員向けアプリにおける**組織単位**（部署・チーム）の目標設定機能に関する、データモデル、主要ロジック、および画面仕様を定義します。

この機能により、`org_personal_goal_setting`権限を持つユーザー（主にマネージャー）は、自身が所属する組織の目標を設定・管理し、その進捗を追跡できます。

---

## 2. データベース設計 (Firestore)

本機能は、既存の`goals`コレクションを拡張して使用します。

### 2.1. `goals` コレクション

*   **コレクションパス**: `/goals`
*   **目的**: 会社・組織・個人のすべての目標設定情報を格納します。`scope: 'team'`のドキュメントが組織単位の目標に該当します。

#### データモデル (`Goal`) - `scope: 'team'`の場合

```typescript
{
  // --- 基本情報 ---
  id: string;          // ドキュメントID
  title: string;       // 目標のタイトル (例: "第3四半期 顧客満足度85%達成")
  scope: "team";       // 対象単位 (この仕様では 'team' に固定)
  scopeId: string;     // 紐づく組織(Organization)のID
  authorId: string;    // 作成者のUID
  
  // --- 期間設定 ---
  startDate: Timestamp;// 目標の開始日
  endDate: Timestamp;  // 目標の終了日

  // --- 目標値と進捗 ---
  targetValue: number; // 目標値 (例: 85)
  currentValue: number;// 現在の進捗値 (例: 60)
  unit: string;        // 値の単位 (例: "%", "件", "人")

  // --- 表示設定 ---
  chartType: "donut" | "bar" | "line"; // グラフの種類
  status: "active" | "inactive"; // 従業員向けアプリでの表示状態 ('active'はscopeIdごとに1つだけ)

  // --- タイムスタンプ ---
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### 2.2. フィールド詳細

| フィールド名     | 説明                                                                                             |
| :--------------- | :----------------------------------------------------------------------------------------------- |
| `scope`          | `'team'` を設定することで、このドキュメントが組織単位の目標であることを示す。                      |
| `scopeId`        | `/organizations`コレクションのドキュメントID。これにより、どの組織の目標かを紐づける。               |
| `startDate`, `endDate` | 会計年度に縛られない、自由な目標期間を設定する。                                                 |
| `targetValue`    | 目標の最終的なゴールとなる数値。                                                                 |
| `currentValue`   | `targetValue`に対する現在の進捗を示す数値。この値を更新することで進捗率が変化する。                |
| `unit`           | `targetValue` と `currentValue` が何を表すかの単位。グラフのラベル表示に使用する。                 |
| `chartType`      | 進捗を可視化するグラフの種類。特に`donut`（ドーナツチャート）を主要な表示方法として想定する。     |
| `status`         | `'active'`に設定された目標が、従業員向けアプリのダッシュボードに表示される。                       |

---

## 3. 機能仕様・ロジック

### 3.1. 権限管理

*   **編集権限**:
    *   ユーザーが`org_personal_goal_setting`権限を持っている場合、**自身が所属する組織（`user.organizationId`）**の目標に限り、作成・編集・削除・表示設定が可能です。
    *   他の組織の目標は閲覧のみ可能とします。
*   **進捗更新**:
    *   目標の進捗（`currentValue`）の更新は、編集権限を持つユーザー（マネージャーなど）が管理画面または従業員向けアプリから行います。（ユーザーアプリ側での更新は将来的な実装）

### 3.2. 管理画面 (`/dashboard/dashboard` の「組織単位」タブ)

1.  **組織セレクターの表示**:
    *   画面上部に、ユーザーが所属する組織名を表示します。（将来的に複数組織を兼務する場合は、セレクターで切り替えられるように拡張）

2.  **ウィジェットの管理**:
    *   会社単位の目標と同様のカード形式で、選択中の組織の目標ウィジェットを一覧表示します。
    *   各ウィジェットには、設定されたグラフ（ドーナツチャートなど）で現在の進捗がプレビュー表示されます。
    *   `org_personal_goal_setting`権限を持つユーザーは、以下の操作が可能です。
        *   **新規作成**: 新しい組織目標（タイトル、期間、目標値、グラフ種類など）を作成します。
        *   **編集**: 既存の目標の設定内容を変更します。
        *   **進捗更新**: `currentValue`を更新するための専用UI（例：「データ編集」メニュー）を提供します。
        *   **表示設定**: アプリに表示するウィジェットを`active`状態に設定します（星マーク）。
        *   **削除**: 目標を削除します。

### 3.3. グラフ表示ロジック

*   **ドーナツチャート (`donut`)**:
    *   `targetValue`を100%としたきの`currentValue`の割合をドーナツグラフで描画します。
    *   グラフの中央には、計算された進捗率（例: `(60 / 85) * 100 ≒ 70.5%`）を大きく表示します。
    *   グラフの外側や下に、現在の値と目標値（例: `60 / 85 件`）をテキストで表示します。
*   **棒グラフ (`bar`) / 折れ線グラフ (`line`)**:
    *   期間が長い目標の場合、月ごとなどの詳細な進捗を管理する必要が出てくる可能性があります。初期実装では単一の目標値・現在値でシンプルに実装し、将来的に`salesRecords`のようなサブコレクションを用いた詳細なグラフ表示に拡張することも可能です。

---

## 4. ユースケース

### UC-01: マネージャーが新しい組織目標を設定する

*   **アクター**: `org_personal_goal_setting`権限を持つマネージャー
*   **シナリオ**:
    1.  マネージャーは「目標設定」画面を開き、「組織単位」タブを選択する。
    2.  「新規ウィジェット追加」ボタンをクリックする。
    3.  ダイアログで、目標タイトル（例: "第3四半期 新規契約100件獲得"）、期間（開始日・終了日）、目標値（`targetValue: 100`）、単位（`unit: "件"`）、グラフ種類（`chartType: "donut"`）を入力し、保存する。
    4.  新しい目標ウィジェットがリストに追加される。

### UC-02: マネージャーが進捗を更新する

*   **アクター**: `org_personal_goal_setting`権限を持つマネージャー
*   **シナリオ**:
    1.  マネージャーは、更新したい目標ウィジェットのメニューから「データ編集」を選択する。
    2.  表示されたダイアログで、現在の進捗値（`currentValue`）を更新し、保存する。
    3.  ウィジェットのプレビューグラフ（ドーナツチャートなど）が即座に更新され、新しい進捗率が反映される。

### UC-03: 一般従業員が組織目標を確認する

*   **アクター**: 一般従業員
*   **シナリオ**:
    1.  従業員は従業員向けアプリのダッシュボードを開く。
    2.  ダッシュボードの「組織目標」セクションに、自身が所属する組織で`status: 'active'`に設定されている目標のグラフが表示される。
    3.  従業員は、自分のチームの目標と現在の達成状況を視覚的に把握する。

