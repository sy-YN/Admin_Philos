# 「ランキング機能」仕様書 (従業員向けアプリ)

## 1. 概要

このドキュメントは、従業員向けアプリケーションに表示される「ランキング機能」の画面構成、データ取得・表示ロジックについて詳細に定義します。

## 2. 画面構成

ランキングページは、以下の3つの主要タブで構成されます。

1.  **個人ランキング**: 個人のエンゲージメント活動を評価するランキング。
2.  **部署ランキング**: 部署単位でのエンゲージメント活動を評価するランキング。
3.  **コンテンツランキング**: 注目を集めているコンテンツを可視化するランキング。

```mermaid
graph TD
    A[ランキングページ] --> B(タブ切り替え);
    B --> C[個人ランキング];
    B --> D[部署ランキング];
    B --> E[コンテンツランキング];

    subgraph C
        direction LR
        C1(全社) --・-- C2(自部署);
    end

    subgraph E
        direction LR
        E1(ビデオ) --・-- E2(メッセージ);
    end
```

---

## 3. 個人ランキング

### 3.1. 表示内容

*   ユーザーの「順位」「アバター」「名前」「スコア」をリスト形式で表示します。
*   ランキングは「総合」「いいね数」「コメント数」「目標達成」の4つのカテゴリで表示できますが、デフォルトでは「総合」ランキングが表示されます。（※初期実装では「総合」のみでも可）
*   **「全社」**と**「自部署」**で表示を切り替えるタブを設置します。
    *   **全社**: 全従業員の中でのランキング。
    *   **自部署**: ログインしているユーザーが所属する部署内でのランキング。

### 3.2. データ取得とロジック

1.  **データソース**:
    *   `/users`: 全ユーザーのプロフィール情報（特に`organizationId`）
    *   `/videos/{videoId}/likes`, `/executiveMessages/{messageId}/likes`: 全てのいいねデータ
    *   `/videos/{videoId}/comments`, `/executiveMessages/{messageId}/comments`: 全てのコメントデータ
    *   `/users/{userId}/personalGoals`: 全ユーザーの個人目標データ
2.  **集計ロジック (リアルタイム)**:
    *   ユーザーがページを開くたびに、上記の全てのデータを取得します。
    *   `docs/ranking_logic_spec.md` に定義された計算ロジックに基づき、各ユーザーのスコアを算出します。
    *   「自部署」タブが選択された場合は、ログインユーザーの`organizationId`を基に、同じ部署のメンバーのみをフィルタリングしてランキングを再計算します。

---

## 4. 部署ランキング

### 4.1. 表示内容

*   部署ごとの「順位」「部署名」「平均スコア」をリスト形式で表示します。

### 4.2. データ取得とロジック

1.  **データソース**: 個人ランキングと同じ。
2.  **集計ロジック (リアルタイム)**:
    *   まず、全メンバーの**個人総合スコア**を算出します。
    *   各メンバーを`organizationId`に基づいて部署ごとにグループ分けします。
    *   部署ごとに、所属メンバーの個人総合スコアの**合計**と、**所属人数**を計算します。
    *   `部署の平均スコア = 合計スコア / 所属人数` の式で最終的なスコアを算出し、そのスコアが高い順にランキングを決定します。

---

## 5. コンテンツランキング

### 5.1. 表示内容

*   「ビデオ」と「メッセージ」を切り替えるサブタブを設置します。
*   各コンテンツの「順位」「タイトル」「投稿者名」「投稿日」「閲覧数（`viewsCount`）」をリスト形式で表示します。
*   ビデオの場合は、サムネイル画像も表示します。

### 5.2. データ取得とロジック

1.  **データソース**:
    *   **ビデオ**: `/videos` コレクション全体
    *   **メッセージ**: `/executiveMessages` コレクション全体
2.  **集計ロジック**:
    *   対応するコレクションの全ドキュメントを取得します。
    *   各ドキュメントが持つ **`viewsCount`** フィールドの値が多い順に並べ替えて表示します。
    *   投稿日は、ビデオの場合は`uploadedAt`、メッセージの場合は`createdAt`フィールドの値をフォーマットして表示します。

---

## 6. 実装上の考慮事項

*   **パフォーマンス**:
    *   現在のリアルタイム集計方式は、データ量が増えると表示パフォーマンスが低下する可能性があります。
    *   将来的には、`docs/ranking_logic_spec.md` に記載の通り、Firebase Functionsを用いたバッチ処理による事前集計方式への移行を検討する必要があります。
*   **UI/UX**:
    *   データの読み込み中は、スケルトンローダーなどを表示し、ユーザーが待機中であることを明確に伝えます。
    *   ランキングリストは、スクロール可能な領域に表示し、大量のデータでも画面レイアウトが崩れないようにします。
