# 「ランキング機能」仕様解説書

## 1. 概要

このドキュメントは、Philosアプリケーションに実装されている「ランキング機能」について、その種類、データソース、およびスコア計算のロジックを網羅的に解説します。

現在、ランキングは「個人ランキング」「部署ランキング」「コンテンツランキング」の3つの主要なカテゴリに分かれています。

**注意**: 現在の実装では、ランキングデータはページが表示されるたびにリアルタイムで集計されます。これはデータ量が増えるとパフォーマンスに影響を与える可能性があるため、将来的には定期的なバッチ処理による事前集計への移行を推奨します。

---

## 2. 個人ランキング

個人のエンゲージメント活動を評価するためのランキングです。従業員向けアプリでは、「全社」と「自部署」で表示を切り替えられます。集計期間は原則として**当月1日から末日まで**です。

### 2.1. いいね数ランキング

-   **目的**: ユーザーがどれだけ積極的に他者の投稿に反応したかを評価します。
-   **データソース**:
    -   `/videos/{videoId}/likes`
    -   `/executiveMessages/{messageId}/likes`
-   **計算ロジック**:
    1.  全ての`videos`と`executiveMessages`コンテンツを取得します。
    2.  それぞれのコンテンツの`likes`サブコレクションから、`likedAt`フィールドが**当月内**であるドキュメントのみを読み込みます。
    3.  ユーザーごとに、**自分が当月内に「いいね」を付けた総数**を集計します。
    4.  この合計「いいね」数が多い順にランキングが決定します。

### 2.2. コメント数ランキング

-   **目的**: ユーザーがどれだけ議論や対話に参加したかを評価します。
-   **データソース**:
    -   `/videos/{videoId}/comments`
    -   `/executiveMessages/{messageId}/comments`
-   **計算ロジック**:
    1.  全ての`videos`と`executiveMessages`コンテンツを取得します。
    2.  それぞれのコンテンツの`comments`サブコレクションから、`createdAt`フィールドが**当月内**であるドキュメントのみを読み込みます。
    3.  コメントの`authorId`フィールドを基に、**ユーザーごとの当月内の総コメント投稿数**を集計します。
    4.  この合計コメント数が多い順にランキングが決定します。

### 2.3. 視聴回数ランキング

-   **目的**: ユーザーがどれだけコンテンツを閲覧したかを評価します。
-   **データソース**:
    -   `/videos/{videoId}/views`
    -   `/executiveMessages/{messageId}/views`
-   **計算ロジック**:
    1.  全ての`videos`と`executiveMessages`コンテンツを取得します。
    2.  それぞれのコンテンツの`views`サブコレクションから、`viewedAt`フィールドが**当月内**であるドキュメントのみを読み込みます。
    3.  ユーザーごとに、**自分が当月内にコンテンツを閲覧した総回数**を集計します。
    4.  この合計閲覧数が多い順にランキングが決定します。

### 2.4. 総合ランキング

-   **目的**: 「いいね」「コメント」「視聴回数」の各活動を総合的に評価し、貢献者を可視化します。
-   **計算ロジック（順位ポイント制）**:
    1.  まず、「いいね数」「コメント数」「視聴回数」の各カテゴリで、それぞれ個別のランキングを算出します。
    2.  各ランキングの**順位**に基づいて、ユーザーに**順位ポイント**を付与します。
        -   ポイント = `(参加総人数) - (自分の順位)`
        -   例: 50人中1位なら `50 - 1 = 49` ポイント、50位なら `50 - 50 = 0` ポイント。
    3.  各ユーザーが3つのカテゴリで獲得した**順位ポイントを全て合算**します。
    4.  この合計ポイントが高い順に、総合ランキングが決定します。

---

## 3. 部署ランキング

部署単位でのエンゲージメント活動を評価するためのランキングです。

-   **目的**: チームとしての一体感や活動の活発さを評価します。
-   **データソース**: 上記の個人ランキングで集計した全データと、`/users`コレクションの`organizationId`。
-   **計算ロジック**:
    1.  まず、全メンバーの**個人総合スコア**（順位ポイントの合計）を算出します。
    2.  各メンバーを、`users`コレクションの`organizationId`を基に所属部署でグループ分けします。
    3.  部署ごとに、所属する全メンバーの個人総合スコアを**合計**します。
    4.  さらに、部署ごとの所属メンバー数をカウントします。
    5.  最後に、部署の「合計スコア」を「所属メンバー数」で割り、**部署の平均スコア**を算出します。
    6.  この平均スコアが高い順にランキングが決定します。

---

## 4. コンテンツランキング

どのコンテンツが注目を集めているかを可視化するランキングです。「ビデオ」と「メッセージ」でそれぞれ集計されます。

-   **目的**: 社内で関心の高いトピックや、影響力のあるコンテンツを把握します。
-   **データソース**:
    -   `/videos` コレクション全体
    -   `/executiveMessages` コレクション全体
-   **計算ロジック**:
    1.  `videos`コレクションと`executiveMessages`コレクションの全ドキュメントをそれぞれ取得します。
    2.  各ドキュメントが持つ`viewsCount`フィールド（閲覧数）の値を取得します。
    3.  この`viewsCount`が多い順にコンテンツを並べ替え、ランキングを決定します。
    4.  投稿日は、ビデオの場合は`uploadedAt`、メッセージの場合は`createdAt`フィールドから取得して表示します。
    
