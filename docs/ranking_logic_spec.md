# プロジェクト仕様書: 個人ランキング機能

このドキュメントは、アプリケーションの「ランキング」機能における**個人ランキング**の各項目の集計ロジックと、総合順位（MVP）の算出方法について詳細に定義します。

---

## 1. ランキングの集計期間

-   すべての個人ランキングの集計は、**当月1日から現在まで**を対象期間としてリアルタイムで計算されます。

---

## 2. ランキング指標の詳細

個人ランキングは、以下の4つの主要な指標で構成されます。

### 2.1. いいね数ランキング

-   **集計対象**: ユーザーが当月内に行った「いいね」のアクションの総数。
-   **ロジック**:
    -   `videos`および`executiveMessages`の各コンテンツ配下にある`likes`サブコレクションに、ユーザーがいいねをするたびにドキュメントが作成されます。
    -   このドキュメントのタイムスタンプ (`likedAt`) を基に、当月内のものをカウントし、ユーザーごとに集計します。
    -   合計数が多い順にランキングが決定されます。

### 2.2. コメント数ランキング

-   **集計対象**: ユーザーが当月内に行ったコメントおよび返信の投稿総数。
-   **ロジック**:
    -   `videos`および`executiveMessages`の各コンテンツ配下にある`comments`サブコレクションに、ユーザーがコメントや返信を投稿するたびにドキュメントが作成されます。
    -   このドキュメントのタイムスタンプ (`createdAt`) を基に、当月内のものをカウントし、ユーザーごとに集計します。
    -   合計数が多い順にランキングが決定されます。

### 2.3. 視聴回数ランキング

-   **集計対象**: ユーザーが当月内にコンテンツ（動画・メッセージ）を最後まで閲覧した回数の総数。
-   **ロジック**:
    -   ユーザーがコンテンツを最後まで閲覧すると、`views`サブコレクションにユーザーIDをドキュメントIDとする閲覧履歴が記録されます。
    -   このドキュメントのタイムスタンプ (`viewedAt`) を基に、当月内のものをカウントし、ユーザーごとに集計します。
    -   同じコンテンツを複数回閲覧しても、月が変わらない限り1回としてカウントされます。
    -   合計数が多い順にランキングが決定されます。

---

## 3. 総合ランキング (MVP) の算出方法

総合ランキングは、各指標の順位に基づいた**ポイント制**で決定されます。これにより、特定の活動に偏らず、多角的に貢献しているユーザーを評価します。

### 3.1. ポイントの計算ロジック

1.  **カテゴリ別順位の決定**:
    -   まず、「いいね数」「コメント数」「視聴回数」の3つのカテゴリそれぞれで、ユーザーのランキングを決定します。

2.  **順位に応じたポイントの付与**:
    -   各カテゴリの順位に応じて、以下の計算式でポイントが付与されます。
    -   **計算式**: `50 - (順位 - 1)`
    -   **例**:
        -   1位: 50ポイント
        -   2位: 49ポイント
        -   3位: 48ポイント
        -   ...
        -   50位以上: 1ポイント（最低1ポイントが付与される）

3.  **総合スコアの算出**:
    -   各ユーザーが3つのカテゴリそれぞれで獲得したポイントを**合計**します。この合計値が、そのユーザーの「総合スコア（MVPスコア）」となります。

4.  **最終順位の決定**:
    -   算出された総合スコアが高い順に、最終的な総合ランキングが決定されます。

### 3.2. 同順位の取り扱い (標準競技ランキング)

-   各カテゴリおよび総合ランキングにおいて、複数のユーザーが同じスコアだった場合は、**標準競技ランキング（"1224"ランキング）** に基づいて順位が決定されます。
-   **例**: 2位のユーザーが2人いた場合、次の順位は3位ではなく4位となります。(1位, 2位, 2位, 4位, ...)

この算出方法により、アプリケーション内での多様な貢献を可視化し、健全な競争とエンゲージメントの向上を促進します。

    